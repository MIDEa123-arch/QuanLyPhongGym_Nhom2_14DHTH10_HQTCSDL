@{
    ViewBag.Title = "Báo Cáo Doanh Thu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Tải thư viện Chart.js từ CDN (Không cần tải về máy) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .chart-container {
        position: relative;
        height: 400px; /* Chiều cao biểu đồ */
        width: 100%;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .s-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #d0e3ff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        text-align: center;
    }

        .s-card h4 {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .s-card p {
            color: #0ea5e9;
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
</style>

<div class="content-card">
    <div class="card-header">
        <h2 class="card-title" style="margin-bottom:20px">📈 Thống Kê Doanh Thu Theo Tháng</h2>
    </div>

    <!-- 1. Khu vực tóm tắt (Optional - Có thể tính toán thêm nếu muốn) -->
    <div class="summary-cards">
        <div class="s-card">
            <h4>Tổng Doanh Thu (Năm nay)</h4>
            <p id="totalRevenue">Đang tính...</p>
        </div>
        <div class="s-card">
            <h4>Tháng Cao Nhất</h4>
            <p id="bestMonth">...</p>
        </div>
    </div>

    <!-- 2. Khu vực biểu đồ -->
    <div class="chart-container">
        <canvas id="revenueChart"></canvas>
    </div>
</div>

<!-- Script vẽ biểu đồ -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        // ================================================================
        // == SỬA LỖI TẠI ĐÂY: Sử dụng để lấy đường dẫn chuẩn ==
        // ================================================================
        // Lưu ý: Code Razor () sẽ được Server xử lý trước khi gửi về trình duyệt.
        // Nếu bạn đang xem ở chế độ Preview (không có Server C#), nó có thể vẫn báo lỗi,
        // nhưng khi chạy thật trong Visual Studio thì sẽ hoạt động 100%.
        var apiUrl = '@Url.Action("GetDoanhThuData", "BaoCao")';

        // Kiểm tra nếu apiUrl bị rỗng hoặc sai (đề phòng trường hợp chạy local html)
        if (!apiUrl || apiUrl === '@Url.Action("GetDoanhThuData", "BaoCao")') {
             // Fallback cho môi trường dev/preview nếu không có server
             console.warn("Đang chạy ở chế độ không có Server C#, sử dụng đường dẫn tĩnh.");
             apiUrl = '/BaoCao/GetDoanhThuData';
        }

        // Gọi API lấy dữ liệu từ Controller
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Mạng hoặc Server gặp sự cố: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {

                // Tách dữ liệu thành 2 mảng: Nhãn (Tháng) và Giá trị (Tiền)
                const labels = data.map(item => item.Label);
                const values = data.map(item => item.Value);

                // Tính toán sơ bộ để hiển thị lên thẻ tóm tắt
                const total = values.reduce((a, b) => a + b, 0);
                const maxVal = Math.max(...values);
                const bestIndex = values.indexOf(maxVal);

                // Format tiền tệ VNĐ
                const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

                document.getElementById('totalRevenue').innerText = formatter.format(total);
                document.getElementById('bestMonth').innerText = labels[bestIndex] || "Chưa có";

                // Cấu hình biểu đồ
                const ctx = document.getElementById('revenueChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar', // Loại biểu đồ: 'bar' (cột), 'line' (đường), 'pie' (tròn)
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Doanh Thu (VNĐ)',
                            data: values,
                            backgroundColor: 'rgba(14, 165, 233, 0.6)', // Màu xanh dương nhạt (Sky Blue)
                            borderColor: 'rgba(14, 165, 233, 1)',       // Viền đậm hơn
                            borderWidth: 1,
                            borderRadius: 5, // Bo tròn góc cột
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Ẩn chú thích (vì chỉ có 1 cột)
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatter.format(context.raw); // Hiển thị tiền VNĐ khi di chuột
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        // Rút gọn số tiền trên trục Y (ví dụ: 1tr, 2tr...)
                                        if(value >= 1000000) return value / 1000000 + ' Tr';
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Lỗi tải dữ liệu:', error);
                // Hiển thị thông báo lỗi lên giao diện để dễ nhận biết
                document.querySelector('.chart-container').innerHTML = `<p style="color:red; text-align:center; padding-top:50px;">Không thể tải dữ liệu biểu đồ.<br>Chi tiết: ${error.message}</p>`;
            });
    });
</script>