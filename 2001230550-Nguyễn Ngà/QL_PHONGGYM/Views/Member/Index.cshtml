@model QL_PHONGGYM.Models.KhachHang
@{
    ViewBag.Title = "Tổng quan";
    Layout = "~/Views/Shared/_LayoutMember.cshtml";

    var kh = Session["KhachHang"] as QL_PHONGGYM.Models.KhachHang;
    var activePackages = ViewBag.GoiTapHienTai as List<QL_PHONGGYM.Models.DangKyGoiTap>;
    var recentOrders = ViewBag.RecentOrders as List<QL_PHONGGYM.Models.HoaDon>;
    decimal tongTien = ViewBag.TongTienTichLuy;
    int soDon = ViewBag.SoDonHang;
}

<div class="bg-white rounded-3 shadow-sm p-4 mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="position-relative">
                <img src="~/Content/Images/user.png" class="rounded-circle border" width="65" height="65">
                <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-secondary border border-white">Member</span>
            </div>
            <div class="ms-3">
                <h5 class="fw-bold mb-1">@kh.TenKH</h5>
                <div class="text-muted small mb-1">@kh.SDT</div>
                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                    @(Model.LoaiKhachHang != null ? Model.LoaiKhachHang.TenLoai : "Thành viên mới")
                </span>
            </div>
        </div>

        <div class="d-flex text-center">
            <div class="px-4 border-end">
                <h5 class="fw-bold mb-0">@soDon</h5>
                <small class="text-muted">Đơn hàng</small>
            </div>
            <div class="px-4">
                <h5 class="fw-bold text-danger mb-0">@string.Format("{0:N0}đ", tongTien)</h5>
                <small class="text-muted">Tổng tiền tích lũy</small>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-primary d-flex align-items-center justify-content-between border-0 shadow-sm mb-2" role="alert" style="background-color: #eef6fc;">
    <div>
        <i class="fas fa-info-circle text-primary me-2"></i>
        <span class="text-primary fw-bold">Đăng ký PT ngay để nhận ưu đãi đặc quyền!</span>
    </div>
    <a href="#" class="btn btn-sm btn-link text-decoration-none fw-bold">Đăng ký ngay</a>
</div>

<div class="alert alert-primary d-flex align-items-center justify-content-between border-0 shadow-sm mb-4" role="alert" style="background-color: #eef6fc;">
    <div>
        <i class="fas fa-map-marker-alt text-primary me-2"></i>
        <span class="text-primary fw-bold">Thêm địa chỉ để đặt đơn hàng nhanh hơn.</span>
    </div>
    <a href="@Url.Action("SoDiaChi", "Member")" class="btn btn-sm btn-link text-decoration-none fw-bold">Thêm địa chỉ</a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="bg-white rounded-3 shadow-sm p-3 h-100">
            <h6 class="fw-bold mb-3 text-uppercase">Đơn hàng & Gói tập gần đây</h6>

            @if (activePackages != null && activePackages.Any())
            {
                foreach (var pack in activePackages)
                {
                    int ngayCon = (pack.NgayKetThuc - DateTime.Now).Days;
                    <div class="card mb-3 border shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex">
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-dumbbell text-danger fa-2x"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h6 class="fw-bold mb-1">Gói tập: @pack.GoiTap.TenGoi</h6>
                                        <p class="text-muted small mb-1">Hết hạn: @pack.NgayKetThuc.ToString("dd/MM/yyyy")</p>
                                        <span class="badge bg-success">Đang hoạt động</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-danger mb-2">Còn @ngayCon ngày</div>
                                    <a href="@Url.Action("CheckoutGoiTap", "GoiTap", new { id = pack.MaGoiTap })" class="btn btn-sm btn-outline-danger fw-bold">Gia hạn</a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }

            @if (recentOrders != null && recentOrders.Any())
            {
                foreach (var item in recentOrders)
                {
                    <div class="card mb-3 border-0 border-bottom">
                        <div class="card-body px-0">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="mb-1">
                                        <span class="text-muted small">Đơn hàng: </span>
                                        <span class="fw-bold">#@item.MaHD</span>
                                        <span class="text-muted small mx-1">•</span>
                                        <span class="text-muted small">@item.NgayLap.ToString("dd/MM/yyyy")</span>
                                    </div>

                                    @foreach (var ct in item.ChiTietHoaDons.Take(1))
                                    {
                                        var tenSP = ct.SanPham?.TenSP ?? ct.DangKyGoiTap?.GoiTap?.TenGoi ?? "Dịch vụ Gym";
                                        <h6 class="fw-bold text-dark mb-1">@tenSP @(item.ChiTietHoaDons.Count > 1 ? "..." : "")</h6>
                                    }

                                    <span class="badge @(item.TrangThai == "Đã thanh toán" ? "bg-success bg-opacity-10 text-success" : "bg-warning bg-opacity-10 text-warning")">
                                        @item.TrangThai
                                    </span>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-danger mb-2">Tổng: @string.Format("{0:N0}đ", item.TongTien)</div>
                                    <a href="@Url.Action("LichSuMuaHang", "Member")" class="text-decoration-none small fw-bold">Xem chi tiết <i class="fas fa-chevron-right"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else if (activePackages == null || !activePackages.Any())
            {
                <div class="text-center py-4">
                    <p class="text-muted small">Bạn chưa có đơn hàng nào.</p>
                    <a href="@Url.Action("GoiTap", "GoiTap")" class="btn btn-danger btn-sm">Đăng ký ngay</a>
                </div>
            }
        </div>
    </div>

    <div class="col-lg-4">
        <div class="bg-white rounded-3 shadow-sm p-3 h-100">
            <h6 class="fw-bold mb-3 text-uppercase">Ưu đãi của bạn</h6>
            <div class="text-center py-5">
                <img src="~/Content/Images/logo.png" style="width: 80px; opacity: 0.5" class="mb-3">
                <p class="text-muted small">Hiện chưa có ưu đãi cá nhân nào.</p>
                <a href="@Url.Action("GoiTap", "GoiTap")" class="text-danger fw-bold text-decoration-none small">Xem các gói tập <i class="fas fa-arrow-right"></i></a>
            </div>
        </div>
    </div>
</div>