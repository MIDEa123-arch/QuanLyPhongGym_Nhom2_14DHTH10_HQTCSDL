@model List<QL_PHONGGYM.Models.HoaDon>
@{
    ViewBag.Title = "Lịch sử mua hàng";
    Layout = "~/Views/Shared/_LayoutMember.cshtml";
}

<div class="bg-white rounded-3 shadow-sm p-4 h-100">
    <h5 class="fw-bold text-uppercase mb-4 pb-2 border-bottom">Lịch sử đơn hàng</h5>

    @if (Model != null && Model.Count > 0)
    {
        <div class="accordion" id="accordionOrders">
            @foreach (var item in Model)
            {
                // Lấy địa chỉ mặc định của khách để hiển thị (Vì bảng Hóa đơn chưa lưu địa chỉ riêng)
                var diaChiGiao = item.KhachHang.DiaChis.FirstOrDefault(d => d.LaDiaChiMacDinh)
                                 ?? item.KhachHang.DiaChis.FirstOrDefault();
                string textDiaChi = diaChiGiao != null
                    ? $"{diaChiGiao.DiaChiCuThe}, {diaChiGiao.PhuongXa}, {diaChiGiao.QuanHuyen}, {diaChiGiao.TinhThanhPho}"
                    : "Tại cửa hàng";

                <div class="card border shadow-sm mb-3 overflow-hidden">

                    <div class="card-header bg-white p-3 d-flex align-items-center justify-content-between cursor-pointer collapsed"
                         data-bs-toggle="collapse"
                         data-bs-target="#order-@item.MaHD"
                         aria-expanded="false"
                         style="cursor: pointer;">

                        <div class="d-flex align-items-center gap-3">
                            <div class="rounded-circle d-flex align-items-center justify-content-center
                                 @(item.TrangThai == "Đã thanh toán" ? "bg-success bg-opacity-10 text-success" : "bg-warning bg-opacity-10 text-warning")"
                                 style="width: 45px; height: 45px;">
                                <i class="fas @(item.TrangThai == "Đã thanh toán" ? "fa-check" : "fa-box-open") fs-5"></i>
                            </div>

                            <div>
                                <div class="fw-bold text-dark">Đơn hàng #@item.MaHD</div>
                                <div class="text-muted small">@item.NgayLap.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        </div>

                        <div class="text-end d-none d-md-block">
                            <div class="fw-bold text-danger">@string.Format("{0:N0} đ", item.TongTien)</div>
                            <div class="badge @(item.TrangThai == "Đã thanh toán" ? "bg-success" : "bg-warning text-dark") rounded-pill">
                                @item.TrangThai
                            </div>
                        </div>

                        <i class="fas fa-chevron-down text-muted transition-icon"></i>
                    </div>

                    <div id="order-@item.MaHD" class="collapse" data-bs-parent="#accordionOrders">
                        <div class="card-body bg-light border-top">

                            <div class="mb-3 pb-3 border-bottom">
                                <h6 class="fw-bold text-uppercase small text-muted mb-2">Thông tin giao hàng</h6>
                                <p class="mb-1 small"><i class="fas fa-user me-2 text-center" style="width:20px"></i> @item.KhachHang.TenKH</p>
                                <p class="mb-1 small"><i class="fas fa-phone me-2 text-center" style="width:20px"></i> @item.KhachHang.SDT</p>
                                <p class="mb-0 small"><i class="fas fa-map-marker-alt me-2 text-center" style="width:20px"></i> @textDiaChi</p>
                            </div>

                            <h6 class="fw-bold text-uppercase small text-muted mb-2">Sản phẩm đã mua</h6>
                            <div class="bg-white rounded border p-2">
                                @foreach (var ct in item.ChiTietHoaDons)
                                {
                                    // Logic lấy tên và hình ảnh (như cũ)
                                    string tenDichVu = "Dịch vụ";
                                    string imgUrl = "/Content/Images/logo.png";

                                    if (ct.SanPham != null)
                                    {
                                        tenDichVu = ct.SanPham.TenSP;
                                        var img = ct.SanPham.HINHANHs.FirstOrDefault(x => x.IsMain == true);
                                        if (img != null) { imgUrl = img.Url; }
                                    }
                                    else if (ct.DangKyGoiTap != null) { tenDichVu = "Gói: " + ct.DangKyGoiTap.GoiTap.TenGoi; }
                                    else if (ct.DangKyPT != null) { tenDichVu = "Thuê PT: " + ct.DangKyPT.NhanVien.TenNV; }
                                    else if (ct.DangKyLop != null) { tenDichVu = "Lớp: " + ct.DangKyLop.LopHoc.TenLop; }

                                    <div class="d-flex align-items-center p-2 border-bottom last-no-border">
                                        <img src="@imgUrl" class="rounded border" style="width: 50px; height: 50px; object-fit: cover;">
                                        <div class="ms-3 flex-grow-1">
                                            <div class="fw-bold text-dark small">@tenDichVu</div>
                                            <div class="text-muted small">x @ct.SoLuong</div>
                                        </div>
                                        <div class="fw-bold text-dark small">@string.Format("{0:N0} đ", ct.DonGia)</div>
                                    </div>
                                }
                            </div>

                            <div class="mt-3 text-end">
                                <div class="small text-muted">Thành tiền: @string.Format("{0:N0} đ", item.TongTien)</div>
                                <div class="small text-muted">Giảm giá: - @string.Format("{0:N0} đ", item.GiamGia ?? 0)</div>
                                @if (item.TrangThai == "Đã thanh toán")
                                {
                                    <div class="fs-5 fw-bold text-danger mt-1">Tổng thanh toán: @string.Format("{0:N0} đ", item.ThanhTien ?? item.TongTien)</div>
                                }
                                else
                                {
                                    <div class="fs-5 fw-bold text-danger mt-1 d-flex justify-content-between">
                                        <a class="btn btn-info text-white py-2 px-3" href="@Url.Action("CheckoutDangKyPT", "CartCheckout", new {url = Request.RawUrl, maHD = item.MaHD, tongTien = item.TongTien, giamGia = item.GiamGia, thanhTien = item.ThanhTien})">Thanh toán</a>
                                        Tổng thanh toán: @string.Format("{0:N0} đ", item.ThanhTien ?? item.TongTien)
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3" style="opacity: 0.5"></i>
            <h6 class="text-muted fw-bold">Chưa có đơn hàng nào</h6>
            <a href="@Url.Action("GoiTap", "GoiTap")" class="btn btn-primary btn-sm mt-2">Mua gói tập ngay</a>
        </div>
    }
</div>

<style>
    /* Hiệu ứng xoay mũi tên khi mở rộng */
    .card-header .transition-icon {
        transition: transform 0.3s ease-in-out;
    }

    .card-header:not(.collapsed) .transition-icon {
        transform: rotate(180deg);
    }

    .last-no-border:last-child {
        border-bottom: none !important;
    }

    /* Hover nhẹ cho header */
    .card-header:hover {
        background-color: #f9f9f9 !important;
    }
</style>